name: Master Daily Workflow (Scrape -> Image -> Deploy)

on:
  schedule:
    # 5:20 AM Mexico City Time (UTC-6) = 11:20 AM UTC
    - cron: '20 11 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  master-process:
    runs-on: ubuntu-latest

    steps:
      # --- SETUP ---
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install all dependencies
        run: |
          pip install requests beautifulsoup4 pytz pillow

      # --- STEP 1: EPG SCRAPER ---
      - name: Run EPG scraper
        run: |
          python epg_scraper.py

      - name: Commit and push updated schedules
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add schedule/ epg.log
          # The '|| exit 0' ensures the workflow continues if there are no new changes to commit
          git commit -m "Auto update Mexico EPG schedules" || exit 0
          git push

      # --- STEP 2: DOWNLOAD IMAGES ---
      - name: Run image downloader
        run: |
          python download_show_images.py

      - name: Commit image changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add downloaded-images schedule
          git commit -m "Download images, deduplicate URLs, convert to WebP" || exit 0
          git push

      # --- STEP 3: DEPLOY TO WORDPRESS ---
      - name: Prepare and Compress Folders
        run: |
          # 1. Logic for Even/Odd naming
          DAY=$(date +%d)
          if [ $((DAY % 2)) -eq 0 ]; then
            echo "Today is EVEN ($DAY). Today -> even, Tomorrow -> odd"
            mv schedule/today even
            mv schedule/tomorrow odd
          else
            echo "Today is ODD ($DAY). Today -> odd, Tomorrow -> even"
            mv schedule/today odd
            mv schedule/tomorrow even
          fi

          # 2. Create GZ archives
          tar -cvzf even.tar.gz even/
          tar -cvzf odd.tar.gz odd/
          tar -cvzf downloaded-images.tar.gz downloaded-images/

      - name: Upload Archives to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          source: "even.tar.gz,odd.tar.gz,downloaded-images.tar.gz"
          target: "/home/programaciontv/htdocs/programaciontv.com.mx/wp-content/uploads/temp_deploy"

      - name: Extract and Execute Remote Commands
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          script: |
            # Set target paths
            BASE_PATH="/home/programaciontv/htdocs/programaciontv.com.mx/wp-content/uploads"
            TEMP_PATH="$BASE_PATH/temp_deploy"
            
            # Extract Schedule files
            mkdir -p $BASE_PATH/schedule
            tar -xzf $TEMP_PATH/even.tar.gz -C $BASE_PATH/schedule/
            tar -xzf $TEMP_PATH/odd.tar.gz -C $BASE_PATH/schedule/
            
            # Extract Images (this will merge/overwrite into existing folder)
            tar -xzf $TEMP_PATH/downloaded-images.tar.gz -C $BASE_PATH/
            
            # Import WP-CLI Command
            cd /home/programaciontv/htdocs/programaciontv.com.mx/
            wp schedule import --allow-root
            
            # Cleanup temp files on server
            rm -rf $TEMP_PATH
