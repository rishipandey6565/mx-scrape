name: Deploy Data to WordPress (Password Auth)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. Compress the directories locally
      - name: Compress directories
        run: |
          # Compress downloaded-images
          if [ -d "downloaded-images" ]; then
            tar -czf downloaded-images.tar.gz downloaded-images
          else
            echo "Directory downloaded-images not found!"
          fi

          # Compress schedule
          if [ -d "schedule" ]; then
            tar -czf schedule.tar.gz schedule
          else
            echo "Directory schedule not found!"
          fi

      # 2. Upload files via SCP using Password
      - name: Upload files via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          source: "downloaded-images.tar.gz,schedule.tar.gz"
          target: "/home/programaciontv/htdocs/programaciontv.com.mx/wp-content/uploads/"

      # 3. Unzip, Run Commands, and Clean up via SSH using Password
      - name: Extract and Run Commands via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          script: |
            # Define paths
            UPLOADS_DIR="/home/programaciontv/htdocs/programaciontv.com.mx/wp-content/uploads"
            SITE_ROOT="/home/programaciontv/htdocs/programaciontv.com.mx/"

            # Go to uploads directory
            cd $UPLOADS_DIR

            # Unzip downloaded-images if it exists
            if [ -f "downloaded-images.tar.gz" ]; then
              echo "Extracting downloaded-images..."
              tar -xzf downloaded-images.tar.gz --overwrite
              rm downloaded-images.tar.gz
            fi

            # Unzip schedule if it exists
            if [ -f "schedule.tar.gz" ]; then
              echo "Extracting schedule..."
              tar -xzf schedule.tar.gz --overwrite
              rm schedule.tar.gz
            fi

            # Go to site root and run the WP import command
            cd $SITE_ROOT
            echo "Running WP Schedule Import..."
            
            # Run the import
            wp schedule import

            echo "Deployment complete."
